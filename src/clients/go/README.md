This file is generated by
[src/clients/docs_generate.zig](/src/clients/docs_generate.zig).

# tigerbeetle-go

The TigerBeetle client for Go.

[![Go Reference](https://pkg.go.dev/badge/github.com/tigerbeetledb/tigerbeetle-go.svg)](https://pkg.go.dev/github.com/tigerbeetledb/tigerbeetle-go)

Make sure to import `github.com/tigerbeetledb/tigerbeetle-go`, not
this repo and subdirectory.

### Prerequisites

* Go >= 1.17

## Setup

```console
$ go mod init tbtest
$ go mod tidy
```

Create `test.go` and copy this into it:

```go
package main

import _ "github.com/tigerbeetledb/tigerbeetle-go"
import "fmt"

func main() {
  fmt.Println("Import ok!")
}
```

And run:

```console
$ go run test.go
```

## Examples

## Basic

See [./samples/basic](./samples/basic) for a Go project
showing many features of the client.

## Creating a Client

```go
client, err := tb.NewClient(0, []string{"3000"}, 1)
if err != nil {
	log.Printf("Error creating client: %s", err)
	return
}
defer client.Close()"
```

`NewClient` takes three arguments: a unique `uint32`
representing the cluster ID, an array of addressess for
all servers in the cluster, a `uint` max concurrency
setting (`1` is a good default and can increase to `4096`
as you need increased throughput).

The following are valid addresses:
* `3000` (interpreted as `127.0.0.1:3000`)
* `127.0.0.1:3000` (interpreted as `127.0.0.1:3000`)
* `127.0.0.1` (interpreted as `127.0.0.1:3001`, `3001` is the default port)

## Creating Accounts

See details for account fields in the [Accounts
reference](https://docs.tigerbeetle.com/reference/accounts).

```go
// Create two accounts
res, err := client.CreateAccounts([]tb_types.Account{
	{
		ID:     uint128("1"),
		Ledger: 1,
		Code:   1,
	},
	{
		ID:     uint128("2"),
		Ledger: 1,
		Code:   1,
	},
})
if err != nil {
	log.Printf("Error creating accounts: %s", err)
	return
}

for _, err := range res {
	log.Printf("Error creating account %d: %s", err.Index, err.Code)
	return
}
```

The `tb_types` package can be imported from `"github.com/tigerbeetledb/tigerbeetle-go/pkg/types"`.

And the `uint128` helper function above can be defined as follows:
```go
func uint128(value string) tb_types.Uint128 {
	x, err := tb_types.HexStringToUint128(value)
	if err != nil {
		panic(err)
	}
	return x
}
```

### Account Flags

The account flags value is a bitfield. See details for
these flags in the [Accounts
reference](https://docs.tigerbeetle.com/reference/accounts#flags).

### Response and Errors

The response is an empty array if all accounts were
created successfully. If the response is non-empty, each
object in the response array contains error information
for an account that failed. The error object contains an
error code and the index of the account in the request
batch.

See all error conditions in the [create_accounts
reference](https://docs.tigerbeetle.com/reference/operations/create_accounts).

```go
res, err := client.CreateAccounts([]tb_types.Account{account1, account2, account3})
if err != nil {
	log.Printf("Error creating accounts: %s", err)
	return
}

for _, err := range res {
	log.Printf("Error creating account %d: %s", err.Index, err.Code)
	return
}
const errors = await client.createAccounts([account1, account2, account3]);

// errors = [{ index: 1, code: 1 }];
for (const error of errors) {
  switch (error.code) {
    case CreateAccountError.exists:
      console.error(`Batch account at ${error.index} already exists.`);
	  break;
    default:
      console.error(`Batch account at ${error.index} failed to create: ${CreateAccountError[error.code]}.`);
  }
}
```

To handle errors you can either 1) exactly match error codes returned
from `client.createAccounts` with enum values in the
`CreateAccountError` object, or you can 2) look up the error code in
the `CreateAccountError` object for a human-readable string.

## Account Lookup

Account lookup is batched, like account creation. Pass
in all IDs to fetch, and matched accounts are returned.

If no account matches an ID, no object is returned for
that account. So the order of accounts in the response is
not necessarily the same as the order of IDs in the
request. You can refer to the ID field in the response to
distinguish accounts.

```go
accounts, err := client.LookupAccounts([]tb_types.Uint128{uint128("1"), uint128("2")})
if err != nil {
	log.Printf("Could not fetch accounts: %s", err)
	return
}
```

## Create Transfers

This creates a journal entry between two accounts.

See details for transfer fields in the [Transfers
reference](https://docs.tigerbeetle.com/reference/transfers).

### Response and Errors

The response is an empty array if all transfers were created
successfully. If the response is non-empty, each object in the
response array contains error information for an transfer that
failed. The error object contains an error code and the index of the
transfer in the request batch.

See all error conditions in the [create_transfers
reference](https://docs.tigerbeetle.com/reference/operations/create_transfers).

The example above shows that the transfer in index 1 failed with
error 1. This error here means that `transfer1` and `transfer3` were
created successfully. But `transfer2` was not created.

### Batching

TigerBeetle performance is maximized when you batch
inserts. The client does not do this automatically for
you. So, for example, you *can* insert 1 million transfers
one at a time like so:

```go
for (let i = 0; i < len(transfers); i++) {
  errors := client.CreateTransfers(transfers[i]);
  // error handling omitted
}
```

But the insert rate will be a *fraction* of
potential. Instead, **always batch what you can**.

The maximum batch size is set in the TigerBeetle server. The default
is 8191.

```go
BATCH_SIZE := 8191
for i := 0; i < len(transfers); i += BATCH_SIZE {
  batch := BATCH_SIZE
  if i + BATCH_SIZE > len(transfers) {
    i = BATCH_SIZE - i
  }
  errors := client.CreateTransfers(transfers[i:i + batch])
  // error handling omitted
}
```

## Development Setup

### On Linux and macOS

```console
$ git clone https://github.com/tigerbeetledb/tigerbeetle
$ cd tigerbeetle/src/clients/go
$ ./tigerbeetle/scripts/install_zig.sh
$ ./scripts/rebuild_binaries.sh
$ ./zgo test
```

### On Windows

```console
$ git clone https://github.com/tigerbeetledb/tigerbeetle
$ cd tigerbeetle/src/clients/go
$ ./tigerbeetle/scripts/install_zig.bat
$ ./scripts/rebuild_binaries.sh
$ ./zgo.bat test
```

